---
import DashboardLayout from '../../layouts/DashboardLayout.astro';
---

<DashboardLayout title="Dashboard">
  <section class="dashboard-page section">
    <div class="container">
      <h2>Dashboard</h2>
      <div class="user-info">
        <img id="avatar" class="avatar" alt="" />
        <p id="greeting" class="greeting"></p>
      </div>
      <p id="old-message-count" class="old-count"></p>
      <ul class="dashboard-links">
        <li><a class="btn" href="/dashboard/messages">Nachrichten</a></li>
      </ul>
    </div>
  </section>
</DashboardLayout>

<style>
  .dashboard-page {
    background-color: var(--auwasser);
    color: var(--taubenblau);
    text-align: center;
  }

  .user-info {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-bottom: 1rem;
  }

  .avatar {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    display: none;
  }

  .greeting {
    margin-top: 0.5rem;
    font-weight: bold;
  }

  .old-count {
    margin-bottom: 1rem;
    font-weight: 600;
  }

  .dashboard-links {
    list-style: none;
    padding: 0;
  }

  .dashboard-links li {
    margin-bottom: 1rem;
  }
</style>

<script>
  async function loadUser() {
    try {
      const res = await fetch('/.auth/me');
      if (!res.ok) return;
      const data = await res.json();
      const user = data.clientPrincipal;
      if (!user) return;
      const name = user.userDetails || 'User';
      document.getElementById('greeting').textContent = `Hallo ${name}!`;
      const avatar = document.getElementById('avatar');
      avatar.src = `https://github.com/${name}.png`;
      avatar.alt = name;
      avatar.style.display = 'block';
    } catch {
      /* ignore */
    }
  }

  async function loadOldMessageCount() {
    try {
      const res = await fetch('/api/dashboard/get-old-message-count');
      if (!res.ok) return;
      const data = await res.json();
      document.getElementById('old-message-count').textContent =
        `Nachrichten Ã¤lter als 6 Monate: ${data.Count}`;
    } catch {
      /* ignore */
    }
  }
  loadUser();
  loadOldMessageCount();
</script>
