---
import DashboardLayout from '../layouts/DashboardLayout.astro';
import GutscheinListe from '../components/GutscheinListe.astro';
import Card from '../components/Card.astro';
import FormField from '../components/FormField.astro';

const gutscheine = null;
---

<DashboardLayout title="Gutscheine">
  <section class="gutscheine section">
    <div class="container">
      <a class="back-link" href="/">&larr; Zurück zur Übersicht</a>
      <div class="gutscheine-grid">
        <Card eyebrow="Neu" title="Gutschein erfassen" subtitle="Verkäufe dokumentieren und optional das Einlösedatum festhalten.">
          <form id="gutschein-formular" class="gutschein-formular">
            <FormField label="Gutscheinnummer" id="gutscheinnummer" hint="Standardmäßig wird die nächste Nummer vorgeschlagen. Bei Bedarf überschreiben.">
              <input id="gutscheinnummer" name="gutscheinnummer" type="text" inputmode="numeric" placeholder="z. B. 202501" />
            </FormField>
            <FormField label="Kaufdatum" id="kaufdatum" required>
              <input id="kaufdatum" name="kaufdatum" type="date" required />
            </FormField>
            <FormField label="Betrag (EUR)" id="betrag" required>
              <input id="betrag" name="betrag" type="number" step="0.01" min="0.01" required />
            </FormField>
            <FormField label="Verkauft an (optional)" id="verkauftAn" hint="Optional: Name oder Kontakt des Käufers.">
              <input id="verkauftAn" name="verkauftAn" type="text" inputmode="text" />
            </FormField>
            <FormField label="Eingelöst am (optional)" id="eingeloestAm" hint="Nur ausfüllen, wenn der Gutschein bereits eingelöst wurde.">
              <input id="eingeloestAm" name="eingeloestAm" type="date" />
            </FormField>
            <button id="senden-button" type="submit" class="primary-button">Gutschein speichern</button>
            <p id="gutschein-status" class="status-message" hidden></p>
          </form>
        </Card>
        <GutscheinListe gutscheine={gutscheine} />
      </div>

      <dialog id="gutschein-einloesen-dialog" class="modal">
        <form id="gutschein-einloesen-form" class="dialog-content">
          <p class="card-eyebrow">Gutschein einlösen</p>
          <h3 id="gutschein-einloesen-nummer">Gutscheinnummer</h3>
          <FormField label="Eingelöst am" id="gutschein-einloesen-datum" required>
            <input id="gutschein-einloesen-datum" name="eingeloestAm" type="date" required />
          </FormField>
          <p id="gutschein-einloesen-status" class="status-message error" hidden></p>
          <div class="dialog-actions">
            <button id="gutschein-einloesen-abbrechen" type="button" class="ghost-button">Abbrechen</button>
            <button id="gutschein-einloesen-speichern" type="submit" class="primary-button">Gutschein einlösen</button>
          </div>
        </form>
      </dialog>
    </div>
  </section>
</DashboardLayout>

<script>
  import { formatDate, formatCurrency, toNumber } from '../utils/formatters';
  import { normalizeGutschein, suggestNextGutscheinnummer, type Gutschein, type GutscheinRaw } from '../utils/gutschein';

  const gutscheinFormular = document.getElementById('gutschein-formular') as HTMLFormElement | null;
  const gutscheinListe = document.getElementById('gutschein-liste');
  const statusNachricht = document.getElementById('gutschein-status');
  const sendenButton = document.getElementById('senden-button') as HTMLButtonElement | null;
  const aktualisierenButton = document.getElementById('aktualisieren-button');
  const gutscheinnummerEingabe = document.getElementById('gutscheinnummer') as HTMLInputElement | null;
  const einloesenDialog = document.getElementById('gutschein-einloesen-dialog') as HTMLDialogElement | null;
  const einloesenForm = document.getElementById('gutschein-einloesen-form') as HTMLFormElement | null;
  const einloesenDatum = document.getElementById('gutschein-einloesen-datum') as HTMLInputElement | null;
  const einloesenStatus = document.getElementById('gutschein-einloesen-status');
  const einloesenNummer = document.getElementById('gutschein-einloesen-nummer');
  const einloesenAbbrechen = document.getElementById('gutschein-einloesen-abbrechen');
  const einloesenSpeichern = document.getElementById('gutschein-einloesen-speichern') as HTMLButtonElement | null;
  let aktuellerEinloeseGutschein: Gutschein | null = null;

  const einloesenStatusZuruecksetzen = () => {
    if (!einloesenStatus) return;
    einloesenStatus.hidden = true;
    einloesenStatus.textContent = '';
  };

  const einloesenDialogSchliessen = () => {
    aktuellerEinloeseGutschein = null;
    if (einloesenDatum) {
      einloesenDatum.value = '';
      einloesenDatum.removeAttribute('min');
    }
    einloesenStatusZuruecksetzen();
    einloesenDialog?.close();
  };

  const einloesenDialogOeffnen = (gutschein: Gutschein) => {
    if (!gutschein?.gutscheinnummer) {
      statusAnzeigen('Die Gutscheinnummer fehlt.', true);
      return;
    }

    aktuellerEinloeseGutschein = gutschein;
    if (einloesenNummer) {
      einloesenNummer.textContent = `Gutschein ${gutschein.gutscheinnummer}`;
    }
    if (einloesenDatum) {
      einloesenDatum.value = '';
      if (gutschein.kaufdatum) {
        einloesenDatum.min = gutschein.kaufdatum;
      }
    }
    einloesenStatusZuruecksetzen();
    if (typeof einloesenDialog?.showModal === 'function') {
      einloesenDialog.showModal();
    } else {
      einloesenDialog?.setAttribute('open', 'true');
    }
  };

  const listeRendern = (gutscheine: Gutschein[]) => {
    if (!gutscheinListe) return;
    gutscheinListe.classList.remove('ladezustand');
    gutscheinListe.innerHTML = '';

    if (!gutscheine || gutscheine.length === 0) {
      const leer = document.createElement('p');
      leer.className = 'empty';
      leer.textContent = 'Noch keine Gutscheine erfasst.';
      gutscheinListe.appendChild(leer);
      return;
    }

    const tabelle = document.createElement('table');
    tabelle.className = 'gutschein-tabelle';

    const thead = document.createElement('thead');
    const kopfZeile = document.createElement('tr');
    kopfZeile.className = 'gutschein-kopf';
    ['Gutscheinnummer', 'Kaufdatum', 'Betrag', 'Verkauft an', 'Eingelöst am'].forEach((titel) => {
      const zelle = document.createElement('th');
      zelle.scope = 'col';
      zelle.textContent = titel;
      kopfZeile.appendChild(zelle);
    });
    thead.appendChild(kopfZeile);
    tabelle.appendChild(thead);

    const tbody = document.createElement('tbody');
    let summeVerkauft = 0;
    let summeOffen = 0;

    gutscheine.forEach((gutschein) => {
      const zeile = document.createElement('tr');
      zeile.className = 'gutschein-zeile';

      const nummer = document.createElement('td');
      nummer.textContent = gutschein.gutscheinnummer || '—';
      zeile.appendChild(nummer);

      const kaufdatum = document.createElement('td');
      kaufdatum.textContent = formatDate(gutschein.kaufdatum);
      zeile.appendChild(kaufdatum);

      const betrag = document.createElement('td');
      betrag.textContent = formatCurrency(gutschein.betrag);
      zeile.appendChild(betrag);

      const aktuellerBetrag = toNumber(gutschein.betrag);
      summeVerkauft += aktuellerBetrag;
      if (!gutschein.eingeloestAm) {
        summeOffen += aktuellerBetrag;
      }

      const verkauftAn = document.createElement('td');
      verkauftAn.textContent = gutschein.verkauftAn || '—';
      zeile.appendChild(verkauftAn);

      const eingeloest = document.createElement('td');
      if (gutschein.eingeloestAm) {
        eingeloest.textContent = formatDate(gutschein.eingeloestAm);
      } else {
        const einloesenButton = document.createElement('button');
        einloesenButton.type = 'button';
        einloesenButton.className = 'link-button';
        einloesenButton.textContent = 'Einlösen';
        einloesenButton.addEventListener('click', () => einloesenDialogOeffnen(gutschein));
        eingeloest.appendChild(einloesenButton);
      }
      zeile.appendChild(eingeloest);

      tbody.appendChild(zeile);
    });

    tabelle.appendChild(tbody);

    const tfoot = document.createElement('tfoot');
    const summenZeile = document.createElement('tr');
    summenZeile.className = 'gutschein-summe';

    const leereZelle = document.createElement('td');
    leereZelle.colSpan = 3;
    leereZelle.setAttribute('aria-hidden', 'true');
    summenZeile.appendChild(leereZelle);

    const summeVerkauftZelle = document.createElement('td');
    summeVerkauftZelle.className = 'gutschein-summe-zelle';
    const summeVerkauftWert = document.createElement('span');
    summeVerkauftWert.className = 'gutschein-summe-betrag';
    summeVerkauftWert.textContent = formatCurrency(summeVerkauft);
    summeVerkauftZelle.append(summeVerkauftWert);
    summenZeile.appendChild(summeVerkauftZelle);

    const summeOffenZelle = document.createElement('td');
    summeOffenZelle.className = 'gutschein-summe-zelle';
    const summeOffenWert = document.createElement('span');
    summeOffenWert.className = 'gutschein-summe-betrag';
    summeOffenWert.textContent = formatCurrency(summeOffen);
    summeOffenZelle.append(summeOffenWert);
    summenZeile.appendChild(summeOffenZelle);

    tfoot.appendChild(summenZeile);
    tabelle.appendChild(tfoot);
    gutscheinListe.appendChild(tabelle);
  };

  const naechsteNummerVorschlagen = (gutscheine: Gutschein[]) => {
    if (!gutscheinnummerEingabe) return;
    const naechsteNummer = suggestNextGutscheinnummer(gutscheine);
    if (!gutscheinnummerEingabe.value) {
      gutscheinnummerEingabe.value = naechsteNummer;
    }
  };

  const gutscheineLaden = async () => {
    if (!gutscheinListe) return;
    gutscheinListe.classList.add('ladezustand');
    gutscheinListe.innerHTML = '<p class="loading-text">Lade Gutscheine...</p>';

    try {
      const antwort = await fetch('/api/gutscheine');
      if (!antwort.ok) throw new Error('Fehler beim Laden der Gutscheine');
      const daten: GutscheinRaw[] = await antwort.json();
      const gutscheine = Array.isArray(daten) ? daten.map(normalizeGutschein) : [];
      listeRendern(gutscheine);
      naechsteNummerVorschlagen(gutscheine);
    } catch (fehler) {
      console.error(fehler);
      gutscheinListe.classList.remove('ladezustand');
      gutscheinListe.innerHTML = '<p class="error">Gutscheine konnten nicht geladen werden.</p>';
    }
  };

  const statusAnzeigen = (nachricht: string, istFehler = false) => {
    if (!statusNachricht) return;
    statusNachricht.hidden = false;
    statusNachricht.textContent = nachricht;
    statusNachricht.classList.toggle('error', istFehler);
  };

  const statusZuruecksetzen = () => {
    if (!statusNachricht) return;
    statusNachricht.hidden = true;
    statusNachricht.textContent = '';
    statusNachricht.classList.remove('error');
  };

  const gutscheinEinloesen = async () => {
    if (!einloesenDatum || !aktuellerEinloeseGutschein) return;

    const eingeloestAm = einloesenDatum.value;
    if (!eingeloestAm) {
      if (einloesenStatus) {
        einloesenStatus.hidden = false;
        einloesenStatus.textContent = 'Bitte Einlösedatum angeben.';
      }
      return;
    }

    einloesenStatusZuruecksetzen();
    if (einloesenSpeichern) {
      einloesenSpeichern.disabled = true;
      einloesenSpeichern.textContent = 'Einlösen...';
    }

    try {
      const antwort = await fetch(`/api/gutscheine/${encodeURIComponent(aktuellerEinloeseGutschein.gutscheinnummer)}/einloesen`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ eingeloestAm })
      });

      if (!antwort.ok) {
        const fehler = await antwort.json().catch(() => null);
        throw new Error(fehler?.detail || 'Gutschein konnte nicht eingelöst werden.');
      }

      statusAnzeigen(`Gutschein ${aktuellerEinloeseGutschein.gutscheinnummer} wurde eingelöst.`);
      einloesenDialogSchliessen();
      await gutscheineLaden();
    } catch (fehler) {
      console.error(fehler);
      if (einloesenStatus) {
        einloesenStatus.hidden = false;
        einloesenStatus.textContent = fehler instanceof Error ? fehler.message : 'Gutschein konnte nicht eingelöst werden.';
      }
    } finally {
      if (einloesenSpeichern) {
        einloesenSpeichern.disabled = false;
        einloesenSpeichern.textContent = 'Gutschein einlösen';
      }
    }
  };

  gutscheinFormular?.addEventListener('submit', async (ereignis) => {
    ereignis.preventDefault();
    statusZuruecksetzen();

    const formData = new FormData(gutscheinFormular);
    const gutscheinnummer = (formData.get('gutscheinnummer') as string)?.trim();
    const kaufdatum = formData.get('kaufdatum') as string;
    const betrag = Number(formData.get('betrag'));
    const eingeloestAm = (formData.get('eingeloestAm') as string) || null;
    const verkauftAn = (formData.get('verkauftAn') as string)?.trim();

    if (!kaufdatum || !betrag) {
      statusAnzeigen('Bitte Kaufdatum und Betrag ausfüllen.', true);
      return;
    }

    if (sendenButton) {
      sendenButton.disabled = true;
      sendenButton.textContent = 'Speichern...';
    }

    try {
      const antwort = await fetch('/api/gutscheine', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          gutscheinnummer: gutscheinnummer || undefined,
          kaufdatum,
          betrag,
          eingeloestAm,
          verkauftAn: verkauftAn || undefined
        })
      });

      if (!antwort.ok) {
        const fehler = await antwort.json().catch(() => null);
        throw new Error(fehler?.detail || 'Gutschein konnte nicht gespeichert werden.');
      }

      const ergebnis = await antwort.json();
      gutscheinFormular.reset();
      naechsteNummerVorschlagen([]);
      statusAnzeigen(`Gutschein ${ergebnis.gutscheinnummer ?? ''} wurde gespeichert.`);
      await gutscheineLaden();
    } catch (fehler) {
      console.error(fehler);
      statusAnzeigen(fehler instanceof Error ? fehler.message : 'Gutschein konnte nicht gespeichert werden.', true);
    } finally {
      if (sendenButton) {
        sendenButton.disabled = false;
        sendenButton.textContent = 'Gutschein speichern';
      }
    }
  });

  aktualisierenButton?.addEventListener('click', gutscheineLaden);
  einloesenForm?.addEventListener('submit', (ereignis) => {
    ereignis.preventDefault();
    gutscheinEinloesen();
  });
  einloesenAbbrechen?.addEventListener('click', einloesenDialogSchliessen);
  einloesenDialog?.addEventListener('cancel', einloesenDialogSchliessen);
  gutscheineLaden();
</script>

<style>
  .gutscheine {
    background-color: var(--schurwolle);
    color: var(--taubenblau);
  }

  .gutscheine-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: 1.5rem;
    margin-top: 1rem;
  }

  .gutschein-formular {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .gutschein-liste {
    border: 1px solid rgba(0, 32, 73, 0.08);
    border-radius: 0.75rem;
    padding: 1rem;
    min-height: 120px;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    width: 100%;
  }

  .gutschein-liste.ladezustand {
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .gutschein-tabelle {
    width: 100%;
    border-collapse: collapse;
    min-width: 640px;
  }

  .gutschein-tabelle th,
  .gutschein-tabelle td {
    text-align: left;
    padding: 0.6rem 0.4rem;
  }

  .gutschein-kopf th {
    font-weight: 700;
    color: var(--taubenblau);
    border-bottom: 2px solid rgba(0, 32, 73, 0.15);
  }

  .gutschein-zeile td {
    border-bottom: 1px solid rgba(0, 32, 73, 0.08);
  }

  .gutschein-zeile:last-child td {
    border-bottom: none;
  }

  .gutschein-summe td {
    border-top: 2px solid rgba(0, 32, 73, 0.15);
    padding-top: 0.85rem;
  }

  .gutschein-summe-zelle {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 0.1rem;
    font-weight: 700;
    color: var(--taubenblau);
  }

  .gutschein-summe-betrag {
    font-size: 1rem;
  }

  .listen-kopf {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 1rem;
    margin-bottom: 0.5rem;
  }

  @media (max-width: 720px) {
    .listen-kopf {
      flex-direction: column;
      align-items: flex-start;
    }

    .gutschein-tabelle th,
    .gutschein-tabelle td {
      padding: 0.5rem;
      font-size: 0.95rem;
    }
  }
</style>
