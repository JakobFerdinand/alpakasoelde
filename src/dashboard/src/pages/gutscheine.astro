---
import DashboardLayout from '../layouts/DashboardLayout.astro';
import GutscheinListe from '../components/GutscheinListe.astro';

const gutscheine = null;
---

<DashboardLayout title="Gutscheine">
  <section class="gutscheine section">
    <div class="container">
      <a class="zurueck-link" href="/">← Zurück zur Übersicht</a>
      <div class="gutscheine-grid">
        <div class="gutschein-karte">
          <p class="eyebrow">Neu</p>
          <h2>Gutschein erfassen</h2>
          <p class="card-subtitle">Verkäufe dokumentieren und optional das Einlösedatum festhalten.</p>
          <form id="gutschein-formular" class="gutschein-formular">
            <div class="form-field">
              <label for="gutscheinnummer">Gutscheinnummer</label>
              <input id="gutscheinnummer" name="gutscheinnummer" type="text" inputmode="numeric" placeholder="z. B. 202501" />
              <p class="form-hint">Standardmäßig wird die nächste Nummer vorgeschlagen. Bei Bedarf überschreiben.</p>
            </div>
            <div class="form-field">
              <label for="kaufdatum">Kaufdatum*</label>
              <input id="kaufdatum" name="kaufdatum" type="date" required />
            </div>
            <div class="form-field">
              <label for="betrag">Betrag (EUR)*</label>
              <input id="betrag" name="betrag" type="number" step="0.01" min="0.01" required />
            </div>
            <div class="form-field">
              <label for="eingeloestAm">Eingelöst am (optional)</label>
              <input id="eingeloestAm" name="eingeloestAm" type="date" />
              <p class="form-hint">Nur ausfüllen, wenn der Gutschein bereits eingelöst wurde.</p>
            </div>
            <button id="senden-button" type="submit" class="primary-button">Gutschein speichern</button>
            <p id="gutschein-status" class="status-message" hidden></p>
          </form>
        </div>
        <GutscheinListe gutscheine={gutscheine} />
      </div>

      <dialog id="gutschein-einloesen-dialog" class="gutschein-dialog">
        <form id="gutschein-einloesen-form" class="gutschein-dialog-inhalt">
          <p class="eyebrow">Gutschein einlösen</p>
          <h3 id="gutschein-einloesen-nummer">Gutscheinnummer</h3>
          <div class="form-field">
            <label for="gutschein-einloesen-datum">Eingelöst am*</label>
            <input id="gutschein-einloesen-datum" name="eingeloestAm" type="date" required />
          </div>
          <p id="gutschein-einloesen-status" class="status-message error" hidden></p>
          <div class="dialog-aktionen">
            <button id="gutschein-einloesen-abbrechen" type="button" class="ghost-button">Abbrechen</button>
            <button id="gutschein-einloesen-speichern" type="submit" class="primary-button">Gutschein einlösen</button>
          </div>
        </form>
      </dialog>
    </div>
  </section>
</DashboardLayout>

<script>
  const gutscheinFormular = document.getElementById('gutschein-formular');
  const gutscheinListe = document.getElementById('gutschein-liste');
  const statusNachricht = document.getElementById('gutschein-status');
  const sendenButton = document.getElementById('senden-button');
  const aktualisierenButton = document.getElementById('aktualisieren-button');
  const gutscheinnummerEingabe = document.getElementById('gutscheinnummer');
  const einloesenDialog = document.getElementById('gutschein-einloesen-dialog');
  const einloesenForm = document.getElementById('gutschein-einloesen-form');
  const einloesenDatum = document.getElementById('gutschein-einloesen-datum');
  const einloesenStatus = document.getElementById('gutschein-einloesen-status');
  const einloesenNummer = document.getElementById('gutschein-einloesen-nummer');
  const einloesenAbbrechen = document.getElementById('gutschein-einloesen-abbrechen');
  const einloesenSpeichern = document.getElementById('gutschein-einloesen-speichern');
  let aktuellerEinloeseGutschein = null;

  const datumFormatieren = (wert) => {
    if (!wert) return '—';
    const datum = new Date(wert);
    if (Number.isNaN(datum.valueOf())) return wert;
    return datum.toLocaleDateString('de-AT', { year: 'numeric', month: '2-digit', day: '2-digit' });
  };

  const betragFormatieren = (wert) => {
    if (wert === null || wert === undefined || Number.isNaN(Number(wert))) return '—';
    return new Intl.NumberFormat('de-AT', { style: 'currency', currency: 'EUR' }).format(Number(wert));
  };

  const betragAlsZahl = (wert) => {
    const betrag = Number(wert);
    return Number.isFinite(betrag) ? betrag : 0;
  };

  const gutscheinNormieren = (gutschein) => {
    const uppercase = gutschein ?? {};

    return {
      gutscheinnummer: gutschein?.gutscheinnummer ?? uppercase.Gutscheinnummer ?? '',
      kaufdatum: gutschein?.kaufdatum ?? uppercase.Kaufdatum ?? '',
      betrag: gutschein?.betrag ?? uppercase.Betrag ?? null,
      eingeloestAm: gutschein?.eingeloestAm ?? uppercase.EingeloestAm ?? null
    };
  };

  const einloesenStatusZuruecksetzen = () => {
    if (!einloesenStatus) return;
    einloesenStatus.hidden = true;
    einloesenStatus.textContent = '';
  };

  const einloesenDialogSchliessen = () => {
    aktuellerEinloeseGutschein = null;
    if (einloesenDatum) {
      einloesenDatum.value = '';
      einloesenDatum.removeAttribute('min');
    }
    einloesenStatusZuruecksetzen();
    einloesenDialog?.close();
  };

  const einloesenDialogOeffnen = (gutschein) => {
    if (!gutschein?.gutscheinnummer) {
      statusAnzeigen('Die Gutscheinnummer fehlt.', true);
      return;
    }

    aktuellerEinloeseGutschein = gutschein;
    if (einloesenNummer) {
      einloesenNummer.textContent = `Gutschein ${gutschein.gutscheinnummer}`;
    }
    if (einloesenDatum) {
      einloesenDatum.value = '';
      if (gutschein.kaufdatum) {
        einloesenDatum.min = gutschein.kaufdatum;
      }
    }
    einloesenStatusZuruecksetzen();
    if (typeof einloesenDialog?.showModal === 'function') {
      einloesenDialog.showModal();
    } else {
      einloesenDialog?.setAttribute('open', 'true');
    }
  };

  const listeRendern = (gutscheine) => {
    gutscheinListe.classList.remove('ladezustand');
    gutscheinListe.innerHTML = '';

    if (!gutscheine || gutscheine.length === 0) {
      const leer = document.createElement('p');
      leer.className = 'leer';
      leer.textContent = 'Noch keine Gutscheine erfasst.';
      gutscheinListe.appendChild(leer);
      return;
    }

    const tabelle = document.createElement('table');
    tabelle.className = 'gutschein-tabelle';

    const thead = document.createElement('thead');
    const kopfZeile = document.createElement('tr');
    kopfZeile.className = 'gutschein-kopf';
    ['Gutscheinnummer', 'Kaufdatum', 'Betrag', 'Eingelöst am'].forEach((titel) => {
      const zelle = document.createElement('th');
      zelle.scope = 'col';
      zelle.textContent = titel;
      kopfZeile.appendChild(zelle);
    });
    thead.appendChild(kopfZeile);
    tabelle.appendChild(thead);

    const tbody = document.createElement('tbody');
    let summeVerkauft = 0;
    let summeOffen = 0;

    gutscheine.forEach((gutschein) => {
      const normalisiert = gutscheinNormieren(gutschein);
      const zeile = document.createElement('tr');
      zeile.className = 'gutschein-zeile';

      const nummer = document.createElement('td');
      nummer.textContent = normalisiert.gutscheinnummer || '—';
      zeile.appendChild(nummer);

      const kaufdatum = document.createElement('td');
      kaufdatum.textContent = datumFormatieren(normalisiert.kaufdatum);
      zeile.appendChild(kaufdatum);

      const betrag = document.createElement('td');
      betrag.textContent = betragFormatieren(normalisiert.betrag);
      zeile.appendChild(betrag);

      const aktuellerBetrag = betragAlsZahl(normalisiert.betrag);
      summeVerkauft += aktuellerBetrag;
      if (!normalisiert.eingeloestAm) {
        summeOffen += aktuellerBetrag;
      }

      const eingeloest = document.createElement('td');
      if (normalisiert.eingeloestAm) {
        eingeloest.textContent = datumFormatieren(normalisiert.eingeloestAm);
      } else {
        const einloesenButton = document.createElement('button');
        einloesenButton.type = 'button';
        einloesenButton.className = 'link-button';
        einloesenButton.textContent = 'Einlösen';
        einloesenButton.addEventListener('click', () => einloesenDialogOeffnen(normalisiert));
        eingeloest.appendChild(einloesenButton);
      }
      zeile.appendChild(eingeloest);

      tbody.appendChild(zeile);
    });

    tabelle.appendChild(tbody);

    const tfoot = document.createElement('tfoot');
    const summenZeile = document.createElement('tr');
    summenZeile.className = 'gutschein-summe';

    const leereZelle = document.createElement('td');
    leereZelle.colSpan = 2;
    leereZelle.setAttribute('aria-hidden', 'true');
    summenZeile.appendChild(leereZelle);

    const summeVerkauftZelle = document.createElement('td');
    summeVerkauftZelle.className = 'gutschein-summe-zelle';
    const summeVerkauftLabel = document.createElement('span');
    summeVerkauftLabel.className = 'gutschein-summe-label';
    summeVerkauftLabel.textContent = 'Summe verkauft';
    const summeVerkauftWert = document.createElement('span');
    summeVerkauftWert.className = 'gutschein-summe-betrag';
    summeVerkauftWert.textContent = betragFormatieren(summeVerkauft);
    summeVerkauftZelle.append(summeVerkauftLabel, summeVerkauftWert);
    summenZeile.appendChild(summeVerkauftZelle);

    const summeOffenZelle = document.createElement('td');
    summeOffenZelle.className = 'gutschein-summe-zelle';
    const summeOffenLabel = document.createElement('span');
    summeOffenLabel.className = 'gutschein-summe-label';
    summeOffenLabel.textContent = 'Summe offen';
    const summeOffenWert = document.createElement('span');
    summeOffenWert.className = 'gutschein-summe-betrag';
    summeOffenWert.textContent = betragFormatieren(summeOffen);
    summeOffenZelle.append(summeOffenLabel, summeOffenWert);
    summenZeile.appendChild(summeOffenZelle);

    tfoot.appendChild(summenZeile);
    tabelle.appendChild(tfoot);
    gutscheinListe.appendChild(tabelle);
  };

  const naechsteNummerVorschlagen = (gutscheine) => {
    if (!gutscheinnummerEingabe) return;

    const jahresPraefix = new Date().getFullYear().toString();
    const hoechsteEndung = gutscheine
      .map((gutschein) => gutscheinNormieren(gutschein).gutscheinnummer)
      .filter((nummer) => nummer?.startsWith(jahresPraefix))
      .map((nummer) => nummer?.slice(jahresPraefix.length) ?? '0')
      .map((endung) => (Number.isNaN(Number(endung)) ? 0 : Number(endung)))
      .reduce((max, aktuell) => Math.max(max, aktuell), 0);

    const naechsteNummer = `${jahresPraefix}${String(hoechsteEndung + 1).padStart(2, '0')}`;
    if (!gutscheinnummerEingabe.value) {
      gutscheinnummerEingabe.value = naechsteNummer;
    }
  };

  const gutscheineLaden = async () => {
    if (!gutscheinListe) return;
    gutscheinListe.classList.add('ladezustand');
    gutscheinListe.innerHTML = '<p class="lade-text">Lade Gutscheine...</p>';

    try {
      const antwort = await fetch('/api/gutscheine');
      if (!antwort.ok) throw new Error('Fehler beim Laden der Gutscheine');
      const daten = await antwort.json();
      const gutscheine = Array.isArray(daten) ? daten : [];
      listeRendern(gutscheine);
      naechsteNummerVorschlagen(gutscheine);
    } catch (fehler) {
      console.error(fehler);
      gutscheinListe.classList.remove('ladezustand');
      gutscheinListe.innerHTML = '<p class="error">Gutscheine konnten nicht geladen werden.</p>';
    }
  };

  const statusAnzeigen = (nachricht, istFehler = false) => {
    if (!statusNachricht) return;
    statusNachricht.hidden = false;
    statusNachricht.textContent = nachricht;
    statusNachricht.classList.toggle('error', istFehler);
  };

  const statusZuruecksetzen = () => {
    if (!statusNachricht) return;
    statusNachricht.hidden = true;
    statusNachricht.textContent = '';
    statusNachricht.classList.remove('error');
  };

  const gutscheinEinloesen = async () => {
    if (!einloesenDatum || !aktuellerEinloeseGutschein) return;

    const eingeloestAm = einloesenDatum.value;
    if (!eingeloestAm) {
      if (einloesenStatus) {
        einloesenStatus.hidden = false;
        einloesenStatus.textContent = 'Bitte Einlösedatum angeben.';
      }
      return;
    }

    einloesenStatusZuruecksetzen();
    if (einloesenSpeichern) {
      einloesenSpeichern.disabled = true;
      einloesenSpeichern.textContent = 'Einlösen...';
    }

    try {
      const antwort = await fetch(`/api/gutscheine/${encodeURIComponent(aktuellerEinloeseGutschein.gutscheinnummer)}/einloesen`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ eingeloestAm })
      });

      if (!antwort.ok) {
        const fehler = await antwort.json().catch(() => null);
        throw new Error(fehler?.detail || 'Gutschein konnte nicht eingelöst werden.');
      }

      statusAnzeigen(`Gutschein ${aktuellerEinloeseGutschein.gutscheinnummer} wurde eingelöst.`);
      einloesenDialogSchliessen();
      await gutscheineLaden();
    } catch (fehler) {
      console.error(fehler);
      if (einloesenStatus) {
        einloesenStatus.hidden = false;
        einloesenStatus.textContent = fehler.message || 'Gutschein konnte nicht eingelöst werden.';
      }
    } finally {
      if (einloesenSpeichern) {
        einloesenSpeichern.disabled = false;
        einloesenSpeichern.textContent = 'Gutschein einlösen';
      }
    }
  };

  gutscheinFormular?.addEventListener('submit', async (ereignis) => {
    ereignis.preventDefault();
    statusZuruecksetzen();

    const gutscheinnummer = gutscheinFormular.gutscheinnummer.value.trim();
    const kaufdatum = gutscheinFormular.kaufdatum.value;
    const betrag = Number(gutscheinFormular.betrag.value);
    const eingeloestAm = gutscheinFormular.eingeloestAm.value || null;

    if (!kaufdatum || !betrag) {
      statusAnzeigen('Bitte Kaufdatum und Betrag ausfüllen.', true);
      return;
    }

    sendenButton.disabled = true;
    sendenButton.textContent = 'Speichern...';

    try {
      const antwort = await fetch('/api/gutscheine', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ gutscheinnummer: gutscheinnummer || undefined, kaufdatum, betrag, eingeloestAm })
      });

      if (!antwort.ok) {
        const fehler = await antwort.json().catch(() => null);
        throw new Error(fehler?.detail || 'Gutschein konnte nicht gespeichert werden.');
      }

      const ergebnis = await antwort.json();
      gutscheinFormular.reset();
      naechsteNummerVorschlagen([]);
      statusAnzeigen(`Gutschein ${ergebnis.gutscheinnummer ?? ''} wurde gespeichert.`);
      await gutscheineLaden();
    } catch (fehler) {
      console.error(fehler);
      statusAnzeigen(fehler.message || 'Gutschein konnte nicht gespeichert werden.', true);
    } finally {
      sendenButton.disabled = false;
      sendenButton.textContent = 'Gutschein speichern';
    }
  });

  aktualisierenButton?.addEventListener('click', gutscheineLaden);
  einloesenForm?.addEventListener('submit', (ereignis) => {
    ereignis.preventDefault();
    gutscheinEinloesen();
  });
  einloesenAbbrechen?.addEventListener('click', einloesenDialogSchliessen);
  einloesenDialog?.addEventListener('cancel', einloesenDialogSchliessen);
  gutscheineLaden();
</script>

<style>
  .gutscheine {
    background-color: var(--schurwolle);
    color: var(--taubenblau);
  }

  .gutscheine-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: 1.5rem;
    margin-top: 1rem;
  }

  .gutschein-karte {
    background: #fff;
    border-radius: 0.75rem;
    padding: 1.5rem;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
  }

  .zurueck-link {
    display: inline-block;
    margin-bottom: 0.5rem;
  }

  .eyebrow {
    font-size: 0.9rem;
    letter-spacing: 0.04em;
    text-transform: uppercase;
    color: var(--sahlchen);
    margin: 0 0 0.25rem;
  }

  .card-subtitle {
    margin: 0.25rem 0 1rem;
    color: rgba(0, 32, 73, 0.7);
  }

  .gutschein-formular {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .form-field {
    display: flex;
    flex-direction: column;
    gap: 0.35rem;
  }

  .form-field label {
    font-weight: 600;
    color: var(--taubenblau);
  }

  .form-field input {
    padding: 0.75rem 0.85rem;
    border: 1px solid rgba(0, 32, 73, 0.15);
    border-radius: 0.5rem;
    font-size: 1rem;
  }

  .form-hint {
    margin: 0;
    color: rgba(0, 32, 73, 0.6);
    font-size: 0.9rem;
  }

  .primary-button {
    background-color: var(--taubenblau);
    color: #fff;
    border: none;
    padding: 0.85rem 1rem;
    border-radius: 0.6rem;
    font-weight: 700;
    cursor: pointer;
  }

  .primary-button:disabled {
    opacity: 0.7;
    cursor: not-allowed;
  }

  .link-button {
    background: none;
    border: none;
    color: var(--taubenblau);
    text-decoration: underline;
    font-weight: 700;
    cursor: pointer;
    padding: 0;
  }

  .link-button:focus-visible {
    outline: 2px solid var(--taubenblau);
    outline-offset: 2px;
  }

  .ghost-button {
    background: transparent;
    border: 1px solid rgba(0, 32, 73, 0.15);
    padding: 0.65rem 0.9rem;
    border-radius: 0.6rem;
    color: var(--taubenblau);
    cursor: pointer;
  }

  .status-message {
    margin: 0;
    font-weight: 600;
    color: var(--weidegruen);
  }

  .status-message.error {
    color: #b00020;
  }

  .gutschein-dialog::backdrop {
    background: rgba(0, 0, 0, 0.35);
  }

  .gutschein-dialog {
    border: none;
    border-radius: 0.75rem;
    padding: 0;
    max-width: 480px;
    width: 100%;
  }

  .gutschein-dialog-inhalt {
    padding: 1.5rem;
    display: flex;
    flex-direction: column;
    gap: 1rem;
    color: var(--taubenblau);
  }

  .dialog-aktionen {
    display: flex;
    justify-content: flex-end;
    gap: 0.75rem;
  }

  .listen-kopf {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 1rem;
    margin-bottom: 0.5rem;
  }

  .gutschein-liste {
    border: 1px solid rgba(0, 32, 73, 0.08);
    border-radius: 0.75rem;
    padding: 1rem;
    min-height: 120px;
    overflow-x: auto;
  }

  .gutschein-liste.ladezustand {
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .gutschein-tabelle {
    width: 100%;
    border-collapse: collapse;
    min-width: 520px;
  }

  .gutschein-tabelle th,
  .gutschein-tabelle td {
    text-align: left;
    padding: 0.6rem 0.4rem;
  }

  .gutschein-kopf th {
    font-weight: 700;
    color: var(--taubenblau);
    border-bottom: 2px solid rgba(0, 32, 73, 0.15);
  }

  .gutschein-zeile td {
    border-bottom: 1px solid rgba(0, 32, 73, 0.08);
  }

  .gutschein-zeile:last-child td {
    border-bottom: none;
  }

  .gutschein-summe td {
    border-top: 2px solid rgba(0, 32, 73, 0.15);
    padding-top: 0.85rem;
  }

  .gutschein-summe-zelle {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 0.1rem;
    font-weight: 700;
    color: var(--taubenblau);
  }

  .gutschein-summe-label {
    font-size: 0.9rem;
    font-weight: 600;
    color: rgba(0, 32, 73, 0.75);
  }

  .gutschein-summe-betrag {
    font-size: 1rem;
  }

  .lade-text,
  .error,
  .leer {
    margin: 0;
  }

  .error {
    color: #b00020;
  }

  @media (max-width: 720px) {
    .listen-kopf {
      flex-direction: column;
      align-items: flex-start;
    }

    .gutschein-tabelle {
      min-width: 100%;
    }

    .gutschein-tabelle th,
    .gutschein-tabelle td {
      padding: 0.5rem;
      font-size: 0.95rem;
    }
  }
</style>
