---
import { Trash2 } from 'lucide-astro';
import DashboardLayout from '../layouts/DashboardLayout.astro';
---

<DashboardLayout title="Nachrichten">
  <section class="dashboard-page section">
    <div class="container">
      <h2>Eingegangene Nachrichten</h2>
      <div class="table-wrapper">
        <table class="message-table data-table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Email</th>
              <th>Nachricht</th>
              <th>Zeitpunkt</th>
              <th class="actions-header">Aktionen</th>
            </tr>
          </thead>
          <tbody id="message-table-body">
            <tr>
              <td colspan="5">Lade Nachrichten...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </section>

  <template id="trash-icon">
    <Trash2 aria-hidden="true" class="delete-icon" />
  </template>
</DashboardLayout>

<script>
  import { formatTimestamp } from '../utils/formatters';

  const columnCount = 5;
  const trashIconTemplate = document.getElementById('trash-icon') as HTMLTemplateElement | null;

  type Message = {
    Id: string;
    Name: string;
    Email: string;
    Message: string;
    Timestamp: string;
  };

  function renderEmptyRow(text: string) {
    const tbody = document.getElementById('message-table-body');
    if (!tbody) return;

    tbody.innerHTML = '';
    const tr = document.createElement('tr');
    tr.innerHTML = `<td colspan="${columnCount}">${text}</td>`;
    tbody.appendChild(tr);
  }

  async function deleteMessage(id: string, row: HTMLTableRowElement) {
    const confirmed = window.confirm('Möchten Sie diese Nachricht wirklich löschen?');
    if (!confirmed) return;

    try {
      const res = await fetch(`/api/messages/${id}`, { method: 'DELETE' });
      if (!res.ok) {
        console.error('Failed to delete message', id, res.status);
        return;
      }

      row.remove();
      const tbody = document.getElementById('message-table-body');
      if (tbody && tbody.children.length === 0) {
        renderEmptyRow('Keine Nachrichten vorhanden.');
      }
    } catch (e) {
      console.error(e);
    }
  }

  async function loadMessages() {
    try {
      const res = await fetch('/api/messages');
      if (!res.ok) return;
      const msgs: Message[] = await res.json();
      const tbody = document.getElementById('message-table-body');
      if (tbody) {
        tbody.innerHTML = '';
        if (msgs.length === 0) {
          renderEmptyRow('Keine Nachrichten gefunden.');
          return;
        }

        msgs.forEach((msg: Message) => {
          const tr = document.createElement('tr');
          const time = formatTimestamp(msg.Timestamp);
          tr.innerHTML = `<td>${msg.Name}</td><td>${msg.Email}</td><td class="message-cell">${msg.Message}</td><td>${time}</td>`;

          const actionCell = document.createElement('td');
          actionCell.classList.add('action-cell');
          const deleteButton = document.createElement('button');
          deleteButton.classList.add('icon-button');
          deleteButton.setAttribute('aria-label', 'Nachricht löschen');
          const iconClone = trashIconTemplate?.content.firstElementChild?.cloneNode(true);
          if (iconClone) {
            deleteButton.appendChild(iconClone);
          }
          deleteButton.addEventListener('click', () => deleteMessage(msg.Id, tr));

          actionCell.appendChild(deleteButton);
          tr.appendChild(actionCell);
          tbody.appendChild(tr);
        });
      }
    } catch (e) {
      console.error(e);
    }
  }
  loadMessages();
</script>

<style>
  .dashboard-page {
    background-color: var(--auwasser);
    color: var(--taubenblau);
  }

  .message-table {
    min-width: 40rem;
  }

  .message-table th {
    position: sticky;
    top: 0;
    z-index: 1;
  }

  .message-cell {
    white-space: pre-wrap;
    word-break: break-word;
  }

  .actions-header,
  .action-cell {
    text-align: center;
    width: 5rem;
  }

  @media (max-width: 600px) {
    .message-table th,
    .message-table td {
      font-size: 0.875rem;
    }
  }
</style>
