---
import { normalizeGutscheine, renderGutscheinTableMarkup } from '../utils/gutscheine';

interface Gutschein {
  gutscheinnummer?: string;
  kaufdatum?: string;
  betrag?: number | string | null;
  eingeloestAm?: string | null;
  Gutscheinnummer?: string;
  Kaufdatum?: string;
  Betrag?: number | string | null;
  EingeloestAm?: string | null;
}

interface Props {
  gutscheine?: Gutschein[] | null;
}

const gutscheineProp = Astro.props.gutscheine ?? null;
const gutscheine = Array.isArray(gutscheineProp) ? gutscheineProp : [];
const normalisierteGutscheine = normalizeGutscheine(gutscheine);
const hatGutscheine = normalisierteGutscheine.length > 0;
const wirdGeladen = gutscheineProp === null;
const tableMarkup = hatGutscheine ? renderGutscheinTableMarkup(normalisierteGutscheine) : '';
---

<div class="gutschein-karte" data-gutschein-liste data-initial-gutscheine={JSON.stringify(gutscheineProp)}>
  <div class="listen-kopf">
    <div>
      <p class="eyebrow">Übersicht</p>
      <h2>Verkaufte Gutscheine</h2>
      <p class="card-subtitle">Alle Gutscheine mit Kauf- und Einlösedaten.</p>
    </div>
    <button id="aktualisieren-button" type="button" class="ghost-button">Aktualisieren</button>
  </div>
  <div id="gutschein-liste" class={`gutschein-liste${wirdGeladen ? ' ladezustand' : ''}`}>
    {wirdGeladen ? (
      <p class="lade-text">Lade Gutscheine...</p>
    ) : hatGutscheine ? (
      <Fragment set:html={tableMarkup} />
    ) : (
      <p class="leer">Noch keine Gutscheine erfasst.</p>
    )}
  </div>
</div>
