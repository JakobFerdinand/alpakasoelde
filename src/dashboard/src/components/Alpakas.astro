---
import Modal from './Modal.astro';
import FormField from './FormField.astro';
---

<section class="dashboard-alpaka section">
  <div class="container">
    <div class="alpaka-header">
      <h2>Alpakas</h2>
      <div class="alpaka-actions">
        <button id="add-event-toggle" class="add-btn" aria-label="Neues Ereignis erfassen" title="Ereignis erfassen">
          <span aria-hidden="true">&#128197;</span>
        </button>
        <button id="add-alpaka-toggle" class="add-btn" aria-label="Neues Alpaka hinzufügen">+</button>
      </div>
    </div>
    <table id="alpaka-table" class="alpaka-table">
      <thead>
        <tr>
          <th></th>
          <th>Name</th>
          <th>Alter</th>
        </tr>
      </thead>
      <tbody id="alpaka-list">
        <tr>
          <td colspan="3" class="alpaka-loading loading">Lade Daten...</td>
        </tr>
      </tbody>
    </table>
  </div>

  <Modal id="alpaka-lightbox" label="Neues Alpaka hinzufügen">
    <form id="add-alpaka-form" class="alpaka-form" method="post" action="/api/alpakas" enctype="multipart/form-data">
      <FormField label="Name" id="alpaka-name" required>
        <input id="alpaka-name" name="name" type="text" maxlength="100" required />
      </FormField>
      <FormField label="Geburtsdatum" id="alpaka-geburtsdatum" required>
        <input id="alpaka-geburtsdatum" name="geburtsdatum" type="date" required />
      </FormField>
      <FormField label="Foto" id="alpaka-photo">
        <input id="alpaka-photo" name="photo" type="file" accept=".png,.jpg,.jpeg" />
      </FormField>
      <button type="submit" class="primary-button">Neues Alpaka anlegen</button>
    </form>
  </Modal>

  <Modal id="event-lightbox" label="Neues Ereignis erfassen">
    <form id="add-event-form" class="alpaka-form" novalidate>
      <FormField label="Ereignis" id="event-type" required>
        <select id="event-type" name="eventType" required>
          <option value="">Bitte auswählen</option>
          <option value="Entwurmen">Entwurmen</option>
          <option value="Nägel schneiden">Nägel schneiden</option>
          <option value="Impfen">Impfen</option>
          <option value="Gesundheitscheck">Gesundheitscheck</option>
          <option value="Sonstiges">Sonstiges</option>
        </select>
      </FormField>
      <FormField label="Alpakas" id="event-alpakas" hint="Mit gedrückter STRG/Cmd Taste mehrere Alpakas auswählen." required>
        <select id="event-alpakas" name="alpakaIds" multiple size="5" required></select>
      </FormField>
      <FormField label="Datum" id="event-date" required>
        <input id="event-date" name="eventDate" type="date" required />
      </FormField>
      <FormField label="Kosten (optional)" id="event-cost">
        <input id="event-cost" name="cost" type="number" min="0" step="0.01" inputmode="decimal" placeholder="0,00" />
      </FormField>
      <FormField label="Notiz" id="event-comment">
        <textarea id="event-comment" name="comment" rows="3" placeholder="Details zum Ereignis"></textarea>
      </FormField>
      <button type="submit" class="primary-button">Ereignis speichern</button>
    </form>
  </Modal>
</section>

<script>
  import { calculateAge } from '../utils/formatters';

  const toggle = document.getElementById('add-alpaka-toggle');
  const eventToggle = document.getElementById('add-event-toggle');
  const lightbox = document.getElementById('alpaka-lightbox') as any;
  const eventLightbox = document.getElementById('event-lightbox') as any;
  const form = document.getElementById('add-alpaka-form') as HTMLFormElement | null;
  const eventForm = document.getElementById('add-event-form') as HTMLFormElement | null;
  const imageUploadInput = document.getElementById('alpaka-photo') as HTMLInputElement | null;
  const eventTypeInput = document.getElementById('event-type') as HTMLSelectElement | null;
  const eventAlpakasSelect = document.getElementById('event-alpakas') as HTMLSelectElement | null;
  const eventDateInput = document.getElementById('event-date') as HTMLInputElement | null;
  const eventCostInput = document.getElementById('event-cost') as HTMLInputElement | null;
  const eventCommentInput = document.getElementById('event-comment') as HTMLTextAreaElement | null;

  const ensureAlpakaSelection = () => {
    if (!eventAlpakasSelect) return;
    const options = Array.from(eventAlpakasSelect.options);
    const hasSelection = options.some((option) => option.selected);
    if (!hasSelection && options.length > 0) {
      options[0].selected = true;
    }
  };

  const openEventLightbox = () => {
    if (eventDateInput) {
      const today = new Date();
      const formatted = today.toISOString().split('T')[0];
      eventDateInput.value = formatted;
    }
    ensureAlpakaSelection();
    eventLightbox?.openModal?.();
  };

  toggle?.addEventListener('click', () => {
    lightbox?.openModal?.();
  });

  eventToggle?.addEventListener('click', () => {
    openEventLightbox();
  });

  const limits: { [key: string]: number } = { 'alpaka-name': 100 };

  Object.entries(limits).forEach(([id, max]) => {
    const el = document.getElementById(id) as HTMLInputElement | null;
    el?.addEventListener('input', () => {
      if (el.value.length > max) {
        el.setCustomValidity(`Maximal ${max} Zeichen erlaubt`);
      } else {
        el.setCustomValidity('');
      }
    });
  });

  const submitButton = form?.querySelector('button[type="submit"]') as HTMLButtonElement | null;
  const submitEventButton = eventForm?.querySelector('button[type="submit"]') as HTMLButtonElement | null;

  form?.addEventListener('submit', (e) => {
    for (const [id, max] of Object.entries(limits)) {
      const el = document.getElementById(id) as HTMLInputElement | null;
      if (el && el.value.trim().length > max) {
        el.setCustomValidity(`Maximal ${max} Zeichen erlaubt`);
        el.reportValidity();
        e.preventDefault();
        return;
      }
    }

    // Client-side file size check
    if (imageUploadInput && imageUploadInput.files && imageUploadInput.files.length > 0) {
      const file = imageUploadInput.files[0];
      const maxFileSize = 15 * 1024 * 1024; // 15 MB (must match backend)
      if (file.size > maxFileSize) {
        alert(`File is too large. Maximum size is ${maxFileSize / (1024 * 1024)}MB.`);
        e.preventDefault();
        if (submitButton) {
            submitButton.disabled = false;
            submitButton.classList.remove('loading');
        }
        return;
      }
    }

    if (submitButton) {
        submitButton.disabled = true;
        submitButton.classList.add('loading');
    }
  });

  eventForm?.addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!eventTypeInput || !eventAlpakasSelect || !eventDateInput) return;

    const selectedAlpakas = Array.from(eventAlpakasSelect.selectedOptions).map((option) => option.value);
    if (!eventTypeInput.value) {
      eventTypeInput.setCustomValidity('Bitte ein Ereignis auswählen.');
      eventTypeInput.reportValidity();
      return;
    }
    eventTypeInput.setCustomValidity('');

    if (selectedAlpakas.length === 0) {
      eventAlpakasSelect.setCustomValidity('Mindestens ein Alpaka auswählen.');
      eventAlpakasSelect.reportValidity();
      return;
    }
    eventAlpakasSelect.setCustomValidity('');

    if (!eventDateInput.value) {
      eventDateInput.setCustomValidity('Bitte ein Datum angeben.');
      eventDateInput.reportValidity();
      return;
    }
    eventDateInput.setCustomValidity('');

    const payload = {
      eventType: eventTypeInput.value,
      alpakaIds: selectedAlpakas,
      eventDate: eventDateInput.value,
      cost: eventCostInput?.value ? Number(eventCostInput.value) : null,
      comment: eventCommentInput?.value.trim() || null,
    };

    try {
      submitEventButton?.classList.add('loading');
      submitEventButton?.setAttribute('disabled', 'true');
      const response = await fetch('/api/events', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });

      if (!response.ok) {
        const errorBody = await response.json().catch(() => ({}));
        throw new Error(errorBody?.detail || 'Das Ereignis konnte nicht gespeichert werden.');
      }

      eventForm.reset();
      eventLightbox?.closeModal?.();
      alert('Ereignis erfolgreich gespeichert.');
    } catch (error) {
      console.error('Fehler beim Speichern des Ereignisses', error);
      alert(error instanceof Error ? error.message : 'Das Ereignis konnte nicht gespeichert werden.');
    } finally {
      submitEventButton?.classList.remove('loading');
      submitEventButton?.removeAttribute('disabled');
    }
  });

  const navigateToAlpaka = (id: string) => {
    window.location.href = `/alpakas?id=${encodeURIComponent(id)}`;
  };

  async function loadAlpakas() {
    const list = document.getElementById('alpaka-list');
    if (!list) return;
    list.innerHTML =
      '<tr><td colspan="3" class="alpaka-loading loading">Lade Daten...</td></tr>';
    try {
      const res = await fetch('/api/alpakas');
      if (!res.ok) return;
      const alpacas = await res.json();
      list.innerHTML = '';

      populateEventAlpakaOptions(alpacas);

      alpacas.forEach((alpaca: { Id: string; Geburtsdatum: string; ImageUrl: string | null; Name: string; }) => {
        const row = document.createElement('tr');
        row.className = 'alpaka-item';
        row.dataset.alpakaId = alpaca.Id;
        row.tabIndex = 0;
        row.setAttribute('role', 'link');
        row.setAttribute('aria-label', `Details für ${alpaca.Name} anzeigen`);
        row.addEventListener('click', () => navigateToAlpaka(alpaca.Id));
        row.addEventListener('keydown', (event) => {
          if (event.key === 'Enter' || event.key === ' ') {
            event.preventDefault();
            navigateToAlpaka(alpaca.Id);
          }
        });

        const age = calculateAge(alpaca.Geburtsdatum);

        // Avatar Cell
        const avatarCell = document.createElement('td');
        if (alpaca.ImageUrl) {
          const img = document.createElement('img');
          img.className = 'alpaka-profile-photo';
          img.src = alpaca.ImageUrl;
          img.alt = alpaca.Name;
          avatarCell.appendChild(img);
        } else {
          const placeholder = document.createElement('div');
          placeholder.className = 'alpaka-profile-placeholder';
          placeholder.textContent = alpaca.Name.charAt(0).toUpperCase();
          avatarCell.appendChild(placeholder);
        }
        row.appendChild(avatarCell);

        // Name Cell
        const nameCell = document.createElement('td');
        nameCell.className = 'alpaka-name';
        nameCell.textContent = alpaca.Name;
        row.appendChild(nameCell);

        // Age Cell
        const ageCell = document.createElement('td');
        ageCell.className = 'alpaka-age';
        ageCell.textContent = age;
        row.appendChild(ageCell);

        list.appendChild(row);
      });
    } catch (error) {
      console.error('Failed to load alpacas:', error);
    }
  }

  loadAlpakas();

  function populateEventAlpakaOptions(alpacas: { Id: string; Name: string }[]) {
    if (!eventAlpakasSelect) return;
    eventAlpakasSelect.innerHTML = '';
    alpacas
      .sort((a, b) => a.Name.localeCompare(b.Name))
      .forEach((alpaka) => {
        const option = document.createElement('option');
        option.value = alpaka.Id;
        option.textContent = alpaka.Name;
        eventAlpakasSelect.appendChild(option);
      });
    ensureAlpakaSelection();
  }
</script>

<style>
  .dashboard-alpaka {
    background-color: var(--himmelblau);
    color: var(--schurwolle);
  }

  .alpaka-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
  }

  .alpaka-table {
    width: 100%;
    border-collapse: collapse;
    background-color: var(--schurwolle);
    color: var(--taubenblau);
    border-radius: 0.5rem;
    overflow: hidden;
  }

  .alpaka-table th,
  .alpaka-table td {
    padding: 0.75rem 1rem;
    text-align: left;
    border-bottom: 1px solid var(--taubenblau);
  }

  .alpaka-table tr:last-child td {
    border-bottom: none;
  }

  .alpaka-name {
    font-weight: 600;
  }

  .alpaka-age {
    text-align: right;
  }

  .alpaka-loading {
    text-align: center;
  }

  .alpaka-actions {
    display: flex;
    gap: 0.5rem;
  }

  .alpaka-form {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .alpaka-item {
    transition: background-color 0.3s ease;
    cursor: pointer;
  }

  .alpaka-item:hover,
  .alpaka-item:focus-visible {
    background-color: var(--auwasser);
  }

  .alpaka-item:focus-visible {
    outline: 2px solid var(--weidegruen);
    outline-offset: -2px;
  }

  @media (max-width: 768px) {
    .alpaka-header {
      flex-direction: column;
      align-items: flex-start;
      gap: 1rem;
    }

    .alpaka-table {
      font-size: 0.9rem;
    }

    .alpaka-age {
      text-align: left;
    }
  }
</style>
